<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MeowLand</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Winky+Rough:ital,wght@0,300..900;1,300..900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  </head>
  <script>
    /* --- 1. Firebase config: вставь сюда свои данные из консоли Firebase --- */
    const firebaseConfig = {
      apiKey: "AIzaSyA6_YmkpdrZnFpLjHb03iJcVE2aml_xuZA",
      authDomain: "meowland-001.firebaseapp.com",
      databaseURL:
        "https://meowland-001-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "meowland-001",
      storageBucket: "meowland-001.appspot.com",
      messagingSenderId: "292419133402",
      appId: "1:292419133402:web:9df893e3c94c332b0d2ae3",
    };

    // Инициализация
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* --- 2. Поставим обработчики на все кнопки — и загрузим начальные значения --- */
    document.addEventListener("DOMContentLoaded", () => {
      const boxes = document.querySelectorAll(".box");

      boxes.forEach((box) => {
        const id = box.dataset.id;
        const btn = box.querySelector(".like-button");
        const counter = btn.querySelector(".like-count");

        // Показываем текущее значение из БД
        const dbRef = db.ref("likes/" + id);
        dbRef.on("value", (snapshot) => {
          const val = snapshot.val();
          counter.textContent = val && val.count ? val.count : 0;
        });

        // Отметка в localStorage, чтобы ограничить повторные клики от одного пользователя
        const localKey = "liked_" + id;
        if (localStorage.getItem(localKey) === "1") {
          btn.classList.add("liked");
        }

        // Клик: делаем транзакцию (безопасно инкрементируем/декрементируем)
        btn.addEventListener("click", () => {
          const liked = localStorage.getItem(localKey) === "1";

          // transaction обеспечивает корректное изменение в условиях параллельных запросов
          db.ref("likes/" + id)
            .transaction((current) => {
              if (current === null) {
                // если пусто — создаём
                return { count: liked ? 0 : 1 };
              } else {
                const curCount = current.count || 0;
                return {
                  count: liked ? Math.max(0, curCount - 1) : curCount + 1,
                };
              }
            })
            .then(() => {
              // обновим localStorage и UI (значение считывается выше через .on('value'))
              if (liked) {
                localStorage.removeItem(localKey);
                btn.classList.remove("liked");
              } else {
                localStorage.setItem(localKey, "1");
                btn.classList.add("liked");
              }
            })
            .catch((err) => {
              console.error("Ошибка транзакции likes:", err);
            });
        });
      });
    });
  </script>
  <body>
    <header>
      <h1>MeowLand - котики, яких ти полюбиш</h1>
    </header>
    <main>
      <div class="carousel-container">
        <div class="carousel-viewport">
          <div class="container">
            <div class="box" data-id="Tiffany">
              <div class="boxmidleone"></div>
              <div class="name-box">
                <h2 class="name-cat">Tiffany</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Pusia">
              <div class="boxmidletwo"></div>
              <div class="name-box">
                <h2 class="name-cat">Pusia</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Kotik">
              <div class="boxmidlethree"></div>
              <div class="name-box">
                <h2 class="name-cat">Kotik</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Muffin">
              <div class="boxmidlefour"></div>
              <div class="name-box">
                <h2 class="name-cat">Muffin</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Stella">
              <div class="boxmidlefive"></div>
              <div class="name-box">
                <h2 class="name-cat">Stella</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Pickles">
              <div class="boxmidlesix"></div>
              <div class="name-box">
                <h2 class="name-cat">Pickles</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Onyx">
              <div class="boxmidleseven"></div>
              <div class="name-box">
                <h2 class="name-cat">Onyx</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Kiki">
              <div class="boxmidleeight"></div>
              <div class="name-box">
                <h2 class="name-cat">Kiki</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Oliver">
              <div class="boxmidlenine"></div>
              <div class="name-box">
                <h2 class="name-cat">Oliver</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
            <div class="box" data-id="Nova">
              <div class="boxmidleten"></div>
              <div class="name-box">
                <h2 class="name-cat">Nova</h2>
                <button class="like-button">
                  <img src="likebutton.png" alt="лайк-котика" />
                  <span class="like-count">0</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="carousel-button back" onclick="scrollCarousel(-1)">
        <svg
          width="70"
          height="70"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M15.5 17C15.5 17.4045 15.2564 17.7691 14.8827 17.9239C14.509 18.0787 14.0789 17.9931 13.7929 17.7071L8.79289 12.7071C8.40237 12.3166 8.40237 11.6834 8.79289 11.2929L13.7929 6.29292C14.0789 6.00692 14.509 5.92137 14.8827 6.07615C15.2564 6.23093 15.5 6.59557 15.5 7.00003V17Z"
            fill="black"
          />
        </svg>
      </button>
      <button class="carousel-button next" onclick="scrollCarousel(1)">
        <svg
          width="70"
          height="70"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M8.5 17C8.5 17.4045 8.74364 17.7691 9.11732 17.9239C9.49099 18.0787 9.92111 17.9931 10.2071 17.7071L15.2071 12.7071C15.5976 12.3166 15.5976 11.6834 15.2071 11.2929L10.2071 6.29292C9.92111 6.00692 9.49099 5.92137 9.11732 6.07615C8.74364 6.23093 8.5 6.59557 8.5 7.00003V17Z"
            fill="black"
          />
        </svg>
      </button>
    </main>
    <footer>
      <p class="copyright">© 2025 goyourpunch. All rights reserved.</p>
    </footer>
    <script>
      let currentIndex = 0;

      function scrollCarousel(direction) {
        const container = document.querySelector(".container");
        const boxWidth = 810; // 610px + 200px отступ
        const visibleCount = 3;
        const totalBoxes = container.children.length;
        const maxIndex = totalBoxes - visibleCount;

        currentIndex += direction;
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex > maxIndex) currentIndex = maxIndex;

        const offset = currentIndex * boxWidth;
        container.style.transform = `translateX(-${offset}px)`;
      }
    </script>
  </body>
</html>
